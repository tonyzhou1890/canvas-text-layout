!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).TextInCanvas={})}(this,(function(t){"use strict";var e={prePunctuation:"([{·‘“〈《「『【〔〖（．［｛￡￥",postPunctuation:"!),.:;?]}¨·ˇˉ―‖’”…∶、。〃々〉》」』】〕〗！＂＇），．：；？］｀｜｝～￠",breakMaxChars:3,englishChars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'",englishMaxWrapChars:5,hyphen:"-",fontFamily:"Microsoft YaHei",fontSize:16,lineHeight:1.5};function n(t){const e=new Map;return[...t].forEach((t=>e.set(t,!0))),e}function i(t){if(!t.textArray.length)return[];const{prePunctuation:i,postPunctuation:r,englishChars:a}=e,h=n(i),o=n(r),s=n(a),d={...t,rowNum:0};d.width="number"!=typeof d.width?1/0:d.width,d.lineHeight=t.fontSize*t.lineHeight,d.rowNum="number"==typeof t.height?Math.floor(t.height/d.lineHeight):1/0;const l=[],c=d.textArray.length;let x=0,u=[],g=0,f=[],p=0,w="",y=0;const I=e.breakMaxChars,m=e.englishMaxWrapChars;let A=!1;for(let t=0;t<c;t++)w=d.textArray[t],0===g&&0===p&&(l[x]={page:x,startIndex:t,endIndex:0,rows:[]}),0===p&&(u[g]={startIndex:t,endIndex:0,chars:[],empty:!1,completed:!0}),"\r"===w||"\n"===w?(f[f.length]=w,"\r"===w&&"\n"===d.textArray[t+1]&&(f[f.length]=d.textArray[t+1],t++),u[g].completed=!1,D(t)):(y=p+d.measures[w],"number"!=typeof d.width||d.width-y>=0?!p&&o.has(w)&&d.textArray[t-1]&&"\r"!==d.textArray[t-1]&&"\n"!==d.textArray[t-1]&&(A=P(t))?(A.prevRow.endIndex=A.endIndex,A.prevPage&&(A.prevPage.endIndex=A.endIndex),t=A.endIndex):h.has(w)&&d.textArray[t-1]&&"\r"!==d.textArray[t-1]&&"\n"!==d.textArray[t-1]&&!s.has(d.textArray[t-1])&&d.width-y<d.measures[d.textArray[t-1]]&&(A=R(t))?(f.splice(A.endIndex-u[g].startIndex+1),D(A.endIndex),t=A.endIndex):s.has(w)&&d.textArray[t-1]&&d.textArray[t+1]&&s.has(d.textArray[t+1])&&d.width-y<d.measures[d.textArray[t+1]]&&(A=H(t))?(f.splice(A.endIndex-u[g].startIndex+1),A.appendix&&(u[g].appendix=A.appendix,f[f.length]=A.appendix),D(A.endIndex),t=A.endIndex):!p&&" "===w&&g&&" "!==u[g-1].chars[u[g-1].chars.length-1]&&" "!==d.textArray[t+1]?(u[g-1].endIndex++,u[g-1].chars.push(w)):(p=y,f[f.length]=w):(t--,D(t)));"\r"!==d.textArray[c-1]&&"\n"!==d.textArray[c-1]&&D(c-1);const v=l[x-1].rows.length;l[x-1].rows[v-1].completed=!1;for(let t=0;t<x;t++){l[t].startIndex+=d.textOffsetIndex,l[t].endIndex+=d.textOffsetIndex;const e=l[t].rows.length;for(let n=0;n<e;n++)l[t].rows[n].startIndex+=d.textOffsetIndex,l[t].rows[n].endIndex+=d.textOffsetIndex}return l;function D(t){u[g].endIndex=t,u[g].chars=f,u[g].empty=0===f.join("").trim().length,g++,f=[],p=0,(g>=d.rowNum||t===c-1)&&function(t){l[x].endIndex=t,l[x].rows=u,x++,u=[],g=0}(t)}function P(t){if(!x&&!g)return!1;let e=null,n=null;g?e=u[g-1]:(n=l[x-1],e=l[x-1].rows[d.rowNum-1]);let i=t-1-I-1,r=null;for(i=e.startIndex>i?e.startIndex:i,r=t-1;r>i;r--)if(!o.has(d.textArray[r]))return{prevPage:n,prevRow:e,endIndex:r-1};return!1}function R(t){if("number"!=typeof d.width)return{endIndex:t-1};let e=t-1-I,n=null;for(e=u[g].startIndex>e?u[g].startIndex:e,n=t-1;n>e;n--)if(!h.has(d.textArray[n]))return{endIndex:n};return!1}function H(t){const e={endIndex:t-1,appendix:""};let n=t-1-m,i=null;for(n=u[g].startIndex>n?u[g].startIndex:n,i=t-1;i>n;i--)if(!s.has(d.textArray[i])){e.endIndex=i;break}return s.has(d.textArray[e.endIndex])&&(e.endIndex=t-1,e.appendix=d.hyphen),e}}function r(t){var n;const i=Date.now(),r={};[null!==(n=t.hyphen)&&void 0!==n?n:e.hyphen,"中"].map((e=>{r[e]=t.ctx.measureText(e).width}));const a=[];for(const e of t.text)a.push(e),r[e]||(r[e]=t.ctx.measureText(e).width);return r["\t"]&&(r["\t"]=2*r["中"]),r["\r"]&&(r["\r"]=0),r["\n"]&&(r["\n"]=0),console.log("measureChars + textArray:",Date.now()-i),{textArray:a,measures:r}}function a(t){return i(t)}function h(t){const e=Date.now(),n={...t,lineHeight:t.fontSize*t.lineHeight,lineWidth:t.width},i=[];return n.rows.map(((t,e)=>{var r;let a=0;const h={startIndex:0,endIndex:0,completed:!1,calculated:!1,letterSpacing:0,chars:[],charsRect:{x:0,y:0,width:0,height:0},rowRect:{x:0,y:0,width:0,height:0}};if(h.rowRect={x:0,y:e*n.lineHeight,width:null!==(r=n.lineWidth)&&void 0!==r?r:0,height:n.lineHeight},t.completed&&"justify"===n.textAlign&&n.lineWidth){let e=0;t.chars.map((t=>{e+=n.measures[t]})),h.letterSpacing=(n.lineWidth-e)/(t.chars.length-1)}const o=h.rowRect.y+(n.lineHeight-n.fontSize)/2;if(t.chars.map(((t,e)=>{const i={x:a,y:o,width:n.measures[t],height:n.fontSize};h.chars[e]={char:t,position:i},a+=n.measures[t]+h.letterSpacing})),h.chars.length===t.chars.length){const t=h.chars[h.chars.length-1];h.charsRect={x:h.rowRect.x,y:h.rowRect.y,width:t?t.position.x+t.position.width:0,height:h.rowRect.height}}if(h.rowRect.width&&("center"===n.textAlign||"right"===n.textAlign)){const t=(h.rowRect.width-h.charsRect.width)/("right"===n.textAlign?1:2);h.charsRect.x+=t,h.chars.map((e=>{e.position.x+=t}))}h.rowRect.width||(h.rowRect.width=h.charsRect.width),i.push(h)})),console.log("layout:",Date.now()-e),i}t.default=class{constructor(t){this.config=null!=t?t:{}}run(t){t&&Object.assign(this.config,t),this.measuredData=r({text:this.config.text,ctx:this.config.ctx,hyphen:this.config.hyphen}),this.resize()}resize(t){var n,i,r,o,s;if(!this.measuredData)throw new Error("Not Measured, please call run");return this.config.width=null!==(n=null==t?void 0:t.width)&&void 0!==n?n:this.config.width,this.config.height=null!==(i=null==t?void 0:t.height)&&void 0!==i?i:this.config.height,this.config.textAlign=null!==(r=null==t?void 0:t.textAlign)&&void 0!==r?r:this.config.textAlign,this.config.lineHeight=null!==(o=null==t?void 0:t.lineHeight)&&void 0!==o?o:this.config.lineHeight,this.textToPageData=a({...this.measuredData,width:this.config.width,height:this.config.height,textOffsetIndex:0,fontSize:this.config.fontSize,lineHeight:this.config.lineHeight,hyphen:null!==(s=this.config.hyphen)&&void 0!==s?s:e.hyphen}),this.textToPageData&&this.textToPageData[0]&&(this.layoutPagesData=this.textToPageData.map((t=>{var e,n;return h({...t,width:this.config.width,fontSize:this.config.fontSize,lineHeight:this.config.lineHeight,textAlign:this.config.textAlign,measures:null!==(n=null===(e=this.measuredData)||void 0===e?void 0:e.measures)&&void 0!==n?n:{}})}))),this.layoutPagesData}render(t){var e,n;if(!this.layoutPagesData)throw new Error("No Data To Render");const i=Date.now(),r=this.layoutPagesData[t.page],a=null!==(e=t.offsetX)&&void 0!==e?e:0,h=null!==(n=t.offsetY)&&void 0!==n?n:0;r.forEach((t=>{t.chars.forEach((t=>{var e,n;null===(n=null===(e=this.config.ctx)||void 0===e?void 0:e.fillText)||void 0===n||n.call(e,t.char,t.position.x+a,t.position.y+h)}))})),console.log("renderPage:",Date.now()-i)}},t.layout=h,t.measureChars=r,t.textToPage=a,Object.defineProperty(t,"__esModule",{value:!0})}));
